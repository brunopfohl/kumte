<!DOCTYPE html>
<html>
<head>
  <title>PDF Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    html, body { 
      height: 100%; 
      width: 100%; 
      overflow: hidden;
      background-color: #f5f5f5;
    }
    #viewerContainer {
      width: 100%;
      height: 100%;
      overflow: auto;
      position: absolute;
      top: 0;
      left: 0;
    }
    #pdfContainer {
      margin: 0 auto;
      background-color: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    .page {
      direction: ltr;
      margin: 10px auto;
      position: relative;
      overflow: visible;
      background-clip: content-box;
      background-color: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    .page canvas {
      display: block;
      margin: 0;
    }
    .textLayer {
      position: absolute;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
      opacity: 0.2;
      line-height: 1.0;
    }
    .textLayer span {
      color: transparent;
      position: absolute;
      white-space: pre;
      cursor: text;
      transform-origin: 0% 0%;
    }
    .textLayer .highlight {
      margin: -1px;
      padding: 1px;
      background-color: rgba(180, 0, 170, 0.2);
      border-radius: 4px;
    }
    .textLayer .highlight.begin {
      border-radius: 4px 0 0 4px;
    }
    .textLayer .highlight.end {
      border-radius: 0 4px 4px 0;
    }
    .textLayer .highlight.middle {
      border-radius: 0;
    }
    .textLayer .highlight.selected {
      background-color: rgba(0, 100, 0, 0.2);
    }
    .loadingMessage {
      color: #333;
      font-size: 16px;
      text-align: center;
      padding: 20px;
    }
    .errorMessage {
      color: red;
      font-size: 16px;
      text-align: center;
      padding: 20px;
    }
    /* Page navigation controls */
    #controls {
      position: fixed;
      bottom: 10px;
      left: 0;
      right: 0;
      text-align: center;
      background-color: rgba(255,255,255,0.8);
      padding: 10px;
      z-index: 1000;
    }
    #controls button {
      padding: 8px 12px;
      margin: 0 5px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #controls button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #pageNumber {
      padding: 8px;
      width: 50px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    #pageCount {
      padding: 8px;
      margin-left: 5px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="messageContainer">
    <div class="loadingMessage">Loading PDF...</div>
  </div>

  <div id="viewerContainer">
    <div id="pdfContainer"></div>
  </div>

  <div id="controls" style="display: none;">
    <button id="prevPage" disabled>Previous</button>
    <input type="number" id="pageNumber" value="1" min="1" />
    <span id="pageCount">/ 0</span>
    <button id="nextPage" disabled>Next</button>
  </div>

  <script>
    // Configure pdf.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // Get viewer elements
    const messageContainer = document.getElementById('messageContainer');
    const viewerContainer = document.getElementById('viewerContainer');
    const pdfContainer = document.getElementById('pdfContainer');
    const controls = document.getElementById('controls');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageNumberInput = document.getElementById('pageNumber');
    const pageCountSpan = document.getElementById('pageCount');

    // PDF state variables
    let pdfDoc = null;
    let pdfPageRendering = false;
    let pageNumPending = null;
    let currentScale = 1.0;
    let currentPage = 1;
    let totalPages = 0;
    let renderedPages = {};
    let currentUrl = '';

    // Get the PDF URL from the query parameters
    function getPdfUrl() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const fileParam = urlParams.get('file') || '';
        if (!fileParam) {
          console.error('No file parameter provided in URL');
          return '';
        }
        
        console.log('Raw file parameter:', fileParam);
        
        // Make sure to decode properly
        const decodedUri = decodeURIComponent(fileParam);
        console.log('Decoded URI:', decodedUri);
        
        return decodedUri;
      } catch (error) {
        console.error('Error getting PDF URL from query params:', error);
        return '';
      }
    }

    // Show error message
    function showError(message) {
      console.error('PDF Viewer Error:', message);
      messageContainer.innerHTML = `<div class="errorMessage">Error: ${message}</div>`;
      
      // Send error back to React Native
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({
          type: 'error',
          message: message
        }));
      }
    }

    // Send loaded message to React Native
    function sendLoadedMessage(pageCount) {
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({
          type: 'loaded',
          pageCount: pageCount
        }));
      }
    }

    // Render a specific page
    function renderPage(pageNum) {
      if (renderedPages[pageNum]) {
        // Page already rendered, just scroll to it
        const pageDiv = document.getElementById(`page-${pageNum}`);
        if (pageDiv) {
          pageDiv.scrollIntoView();
          currentPage = pageNum;
          pageNumberInput.value = currentPage;
          updateUIState();
          return;
        }
      }
      
      pdfPageRendering = true;

      // Get the page
      pdfDoc.getPage(pageNum).then(function(page) {
        const viewport = page.getViewport({ scale: currentScale });
        
        // Create page div
        const pageDiv = document.createElement('div');
        pageDiv.className = 'page';
        pageDiv.id = `page-${pageNum}`;
        pageDiv.style.width = `${viewport.width}px`;
        pageDiv.style.height = `${viewport.height}px`;
        pdfContainer.appendChild(pageDiv);
        
        // Create canvas for rendering
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        pageDiv.appendChild(canvas);
        
        // Create text layer div
        const textLayerDiv = document.createElement('div');
        textLayerDiv.className = 'textLayer';
        textLayerDiv.style.width = `${viewport.width}px`;
        textLayerDiv.style.height = `${viewport.height}px`;
        pageDiv.appendChild(textLayerDiv);
        
        // Render PDF page
        const renderContext = {
          canvasContext: context,
          viewport: viewport
        };
        
        const renderTask = page.render(renderContext);
        
        // Wait for rendering to finish
        renderTask.promise.then(function() {
          // Add page to rendered pages
          renderedPages[pageNum] = true;
          
          // Get the text content
          return page.getTextContent();
        }).then(function(textContent) {
          // Create text layer
          const textLayer = new TextLayerBuilder({
            textLayerDiv: textLayerDiv,
            pageIndex: page.pageIndex,
            viewport: viewport
          });
          
          textLayer.setTextContent(textContent);
          textLayer.render();
          
          // Set current page
          currentPage = pageNum;
          pageNumberInput.value = currentPage;
          
          // Check if we're done rendering
          pdfPageRendering = false;
          
          // If there's a page pending, render it
          if (pageNumPending !== null) {
            renderPage(pageNumPending);
            pageNumPending = null;
          }
          
          // Update UI
          updateUIState();
        }).catch(function(error) {
          pdfPageRendering = false;
          console.error('Error rendering PDF page:', error);
          showError(`Error rendering page ${pageNum}: ${error.message}`);
        });
      }).catch(function(error) {
        pdfPageRendering = false;
        console.error('Error getting PDF page:', error);
        showError(`Error getting page ${pageNum}: ${error.message}`);
      });
    }

    // Queue rendering of a page
    function queueRenderPage(pageNum) {
      if (pdfPageRendering) {
        pageNumPending = pageNum;
      } else {
        renderPage(pageNum);
      }
    }

    // Go to previous page
    function onPrevPage() {
      if (currentPage <= 1) {
        return;
      }
      currentPage--;
      queueRenderPage(currentPage);
    }

    // Go to next page
    function onNextPage() {
      if (currentPage >= totalPages) {
        return;
      }
      currentPage++;
      queueRenderPage(currentPage);
    }

    // Update UI state based on current page
    function updateUIState() {
      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = currentPage >= totalPages;
      pageNumberInput.max = totalPages;
      controls.style.display = 'block';
    }

    // Text layer builder (simplified)
    function TextLayerBuilder(options) {
      this.textLayerDiv = options.textLayerDiv;
      this.pageIdx = options.pageIndex;
      this.viewport = options.viewport;
      this.textDivs = [];
      this.textContent = null;
    }

    TextLayerBuilder.prototype = {
      setTextContent: function(textContent) {
        this.textContent = textContent;
      },
      
      render: function() {
        if (!this.textContent) return;
        
        const textItems = this.textContent.items;
        const textDivs = this.textDivs;
        const viewport = this.viewport;
        
        for (let i = 0, len = textItems.length; i < len; i++) {
          const item = textItems[i];
          
          const tx = pdfjsLib.Util.transform(
            viewport.transform,
            item.transform
          );
          
          const style = this.calculateStyles(tx, item);
          
          const textDiv = document.createElement('span');
          textDiv.style.left = style.left;
          textDiv.style.top = style.top;
          textDiv.style.fontSize = style.fontSize;
          textDiv.style.fontFamily = style.fontFamily;
          textDiv.style.transform = style.transform;
          textDiv.textContent = item.str;
          
          this.textLayerDiv.appendChild(textDiv);
          textDivs.push(textDiv);
        }
      },
      
      calculateStyles: function(tx, item) {
        const style = {};
        
        // Text positioning
        style.left = `${tx[4]}px`;
        style.top = `${tx[5]}px`;
        
        // Font settings
        style.fontSize = `${tx[0] * 100}%`;
        style.fontFamily = item.fontName || 'sans-serif';
        
        // Apply rotation if needed
        if (tx[1] !== 0) {
          const angle = Math.atan2(tx[1], tx[0]);
          style.transform = `rotate(${angle}rad)`;
        }
        
        return style;
      }
    };

    // Initialize PDF loading
    function initPDF() {
      const url = getPdfUrl();
      
      if (!url) {
        showError('No PDF URL provided');
        return;
      }
      
      currentUrl = url;
      console.log('Attempting to load PDF from URL:', url);
      
      // Add an extra timeout to make sure the WebView is fully initialized
      setTimeout(() => {
        // Load the PDF
        pdfjsLib.getDocument({
          url: url,
          withCredentials: false,
          cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
          cMapPacked: true,
          // Force using range requests for local files to avoid CORS issues
          rangeChunkSize: 65536,
          disableStream: false,
          disableAutoFetch: false
        }).promise.then(function(pdf) {
          pdfDoc = pdf;
          totalPages = pdf.numPages;
          
          // Update page count
          pageCountSpan.textContent = `/ ${totalPages}`;
          
          // Hide loading message
          messageContainer.style.display = 'none';
          
          // Send loaded message to React Native
          sendLoadedMessage(totalPages);
          
          // Render first page
          renderPage(1);
          
          // Set up page navigation
          prevPageBtn.addEventListener('click', onPrevPage);
          nextPageBtn.addEventListener('click', onNextPage);
          
          pageNumberInput.addEventListener('change', function() {
            const pageNum = parseInt(this.value);
            if (pageNum >= 1 && pageNum <= totalPages) {
              queueRenderPage(pageNum);
            }
          });
          
        }).catch(function(error) {
          console.error('Error loading PDF:', error);
          
          // Get detailed error information
          let errorDetails = 'Unknown error';
          if (error instanceof Error) {
            errorDetails = error.message;
            // Special handling for common PDF.js errors
            if (error.name === 'MissingPDFException') {
              errorDetails = 'The PDF file could not be found or is invalid.';
            } else if (error.name === 'UnexpectedResponseException') {
              errorDetails = 'The server responded with an unexpected format.';
            } else if (error.name === 'InvalidPDFException') {
              errorDetails = 'The PDF file is invalid or corrupted.';
            } else if (error.name === 'PasswordException') {
              errorDetails = 'The PDF file is password protected.';
            } else if (errorDetails.includes('Access denied') || errorDetails.includes('permission denied')) {
              errorDetails = 'Storage permission denied. Cannot access files.';
            }
          }
          
          showError(`Could not load PDF: ${errorDetails}`);
        });
      }, 500); // Short delay to ensure WebView is ready
    }

    // Initialize when the page loads
    window.addEventListener('load', initPDF);

    // Add additional error handling
    window.addEventListener('error', function(event) {
      console.error('Global error:', event.message);
      showError(`JavaScript error: ${event.message}`);
      // Send detailed error back to React Native
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({
          type: 'error',
          message: `JavaScript error: ${event.message} at ${event.filename}:${event.lineno}`
        }));
      }
      return false;
    });
  </script>
</body>
</html> 